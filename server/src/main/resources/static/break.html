<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Take a Break! â˜•</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Plus+Jakarta+Sans:wght@500;600;700;800&display=swap');

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      display: flex;
      font-family: 'Plus Jakarta Sans', 'Segoe UI', sans-serif;
      transition: background 1s ease;
    }

    /* â”€â”€ LEFT 75%: GIF panel â”€â”€ */
    #gif-panel {
      width: 62%;
      flex: 0 0 62%;
      height: 100%;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    #gif-panel img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
      display: block;
    }

    /* subtle dark vignette so the panel feels rich */
    #gif-panel::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(ellipse at center, transparent 55%, rgba(0,0,0,.35) 100%);
      pointer-events: none;
    }

    /* â”€â”€ RIGHT 25%: Info panel â”€â”€ */
    #info-panel {
      --theme-accent-rgb: 255, 255, 255;
      --theme-text-rgb: 20, 20, 20;
      width: 38%;
      flex: 0 0 38%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 28px;
      padding: 32px 20px;
      transition: background 1.2s ease, color 1.2s ease;
      position: relative;
      overflow: hidden;
      border-left: 1px solid rgba(255,255,255,.18);
    }

    /* animated gradient overlay behind info panel */
    #info-panel::before {
      content: '';
      position: absolute;
      inset: 0;
      background:
        linear-gradient(145deg, rgba(var(--theme-accent-rgb), .20), transparent 52%),
        repeating-linear-gradient(120deg, rgba(var(--theme-accent-rgb), .10) 0 2px, transparent 2px 14px),
        radial-gradient(circle at 18% 16%, rgba(var(--theme-accent-rgb), .18) 0 18%, transparent 20%),
        radial-gradient(circle at 84% 84%, rgba(var(--theme-text-rgb), .10) 0 16%, transparent 18%),
        inherit;
      filter: brightness(0.85);
      z-index: 0;
    }

    #info-panel::after {
      content: '';
      position: absolute;
      inset: 0;
      background-image: radial-gradient(rgba(var(--theme-text-rgb), .18) 1px, transparent 1px);
      background-size: 22px 22px;
      opacity: .3;
      z-index: 0;
      pointer-events: none;
    }

    #info-panel > :not(.theme-sparkles) { position: relative; z-index: 1; }

    .theme-sparkles {
      position: absolute;
      inset: 0;
      z-index: 0;
      pointer-events: none;
    }

    .spark {
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 2px;
      transform: rotate(45deg);
      background: rgba(var(--theme-accent-rgb), .35);
      box-shadow: 0 0 12px rgba(var(--theme-accent-rgb), .22);
      animation: sparkleFloat 6s ease-in-out infinite;
    }

    .spark:nth-child(1) { top: 10%; left: 14%; animation-delay: 0s; }
    .spark:nth-child(2) { top: 24%; right: 16%; animation-delay: 1.1s; width: 8px; height: 8px; }
    .spark:nth-child(3) { top: 48%; left: 10%; animation-delay: 2.2s; width: 7px; height: 7px; }
    .spark:nth-child(4) { bottom: 26%; right: 12%; animation-delay: 0.6s; }
    .spark:nth-child(5) { bottom: 12%; left: 18%; animation-delay: 1.8s; width: 7px; height: 7px; }

    @keyframes sparkleFloat {
      0%, 100% { opacity: .35; transform: translateY(0) rotate(45deg) scale(1); }
      50% { opacity: .75; transform: translateY(-5px) rotate(45deg) scale(1.15); }
    }

    .break-label {
      font-size: 1rem;
      letter-spacing: .25em;
      text-transform: uppercase;
      opacity: .75;
      font-weight: 700;
    }

    .glass-card {
      width: min(92%, 430px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 26px;
      padding: 26px 22px;
      border-radius: 22px;
      position: relative;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.48);
      backdrop-filter: blur(12px);
      box-shadow:
        0 0 0 2px rgba(var(--theme-accent-rgb), .24),
        0 0 28px rgba(var(--theme-accent-rgb), .38),
        0 0 54px rgba(var(--theme-accent-rgb), .24),
        0 18px 38px rgba(0,0,0,.20);
    }

    .glass-card::before {
      content: '';
      position: absolute;
      inset: -2px;
      border-radius: 24px;
      pointer-events: none;
      border: 2px solid rgba(var(--theme-accent-rgb), .55);
      box-shadow:
        0 0 16px rgba(var(--theme-accent-rgb), .60),
        0 0 34px rgba(var(--theme-accent-rgb), .42);
    }

    .break-title {
      font-size: 2rem;
      font-family: 'DM Serif Display', Georgia, serif;
      font-weight: 400;
      letter-spacing: .01em;
      text-align: center;
      line-height: 1.2;
    }

    .break-sub {
      font-size: .9rem;
      text-align: center;
      opacity: .75;
      font-weight: 600;
      max-width: 200px;
      line-height: 1.5;
    }


    /* â”€â”€ Clock SVG countdown â”€â”€ */
    #clock-wrap {
      position: relative;
      width: 160px;
      height: 160px;
    }

    #clock-svg {
      width: 160px;
      height: 160px;
      transform: rotate(-90deg);
    }

    #clock-track {
      fill: none;
      stroke-width: 10;
      opacity: .2;
    }

    #clock-progress {
      fill: none;
      stroke-width: 10;
      stroke-linecap: round;
      transition: stroke-dashoffset .9s linear, stroke 1.2s ease;
    }

    #clock-text {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    #time-display {
      font-size: 2.2rem;
      font-weight: 800;
      font-variant-numeric: tabular-nums;
      letter-spacing: .04em;
      line-height: 1;
    }

    #time-label {
      font-size: .7rem;
      letter-spacing: .15em;
      text-transform: uppercase;
      opacity: .65;
      margin-top: 4px;
    }

    /* â”€â”€ Breathing tip â”€â”€ */
    .tip-box {
      background: rgba(255,255,255,.15);
      border-radius: 16px;
      padding: 16px 20px;
      text-align: center;
      font-size: 1rem;
      line-height: 1.7;
      font-weight: 600;
      max-width: 280px;
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,.25);
      box-shadow: 0 8px 22px rgba(0,0,0,.12);
    }

    /* â”€â”€ Done state â”€â”€ */
    #done-msg {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      animation: popIn .5s cubic-bezier(.34,1.56,.64,1) forwards;
    }

    @keyframes popIn {
      from { transform: scale(.6); opacity: 0; }
      to   { transform: scale(1);  opacity: 1; }
    }

    .done-emoji { font-size: 3rem; }

    .done-text {
      font-size: 1.1rem;
      font-weight: 800;
      text-align: center;
    }

    /* â”€â”€ Breathing animation ring â”€â”€ */
    @keyframes breathe {
      0%, 100% { transform: scale(1); }
      50%       { transform: scale(1.06); }
    }

    #clock-wrap { animation: breathe 4s ease-in-out infinite; }
  </style>
</head>
<body>

<!-- LEFT: GIF -->
<div id="gif-panel">
  <img id="gif-img" src="" alt="Relaxing gif" />
</div>

<!-- RIGHT: Info + countdown -->
<div id="info-panel">
  <div class="theme-sparkles" aria-hidden="true">
    <span class="spark"></span>
    <span class="spark"></span>
    <span class="spark"></span>
    <span class="spark"></span>
    <span class="spark"></span>
  </div>

  <div class="glass-card">
    <div class="break-label">Hey there ğŸ‘‹</div>

    <div class="break-title">Time for a<br/>Break!</div>
    <div class="break-sub">Step away, stretch, grab some water. You've earned it! ğŸŒ¿</div>

    <!-- Countdown clock -->
    <div id="clock-wrap">
      <svg id="clock-svg" viewBox="0 0 160 160">
        <circle id="clock-track"   cx="80" cy="80" r="68"/>
        <circle id="clock-progress" cx="80" cy="80" r="68"
                stroke-dasharray="427.26"
                stroke-dashoffset="0"/>
      </svg>
      <div id="clock-text">
        <div id="time-display">05:00</div>
        <div id="time-label">remaining</div>
      </div>
    </div>

    <!-- Breathing tip -->
    <div class="tip-box" id="tip-box">
      ğŸ’¨ <strong>4-7-8 Breathing</strong><br/>
      Inhale 4s Â· Hold 7s Â· Exhale 8s
    </div>

    <!-- Done message (hidden until countdown ends) -->
    <div id="done-msg">
      <div class="done-emoji">ğŸ‰</div>
      <div class="done-text">Break done!<br/>Back to it â€” you've got this!</div>
    </div>
  </div>

</div>

<script>
  // â”€â”€ GIF data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Each entry: { url, palette: [bg, text, accent] }
  const GIFS = [
    {
      // cat art â€“ warm pink/peach
      url: 'https://media.giphy.com/media/5edvYDFDX1AFpED0OP/giphy.gif',
      palette: { bg: 'linear-gradient(160deg,#f9a8c9,#fbd3e0)', text: '#6b1f3a', accent: '#e05580' }
    },
    {
      // dance happy â€“ vivid yellow/orange
      url: 'https://media.giphy.com/media/3ohzgSHpvk6b8M7f9e/giphy.gif',
      palette: { bg: 'linear-gradient(160deg,#ffd166,#ff9a3c)', text: '#5a2800', accent: '#ff6b35' }
    },
    {
      // laundromat illustration â€“ soft blue/teal
      url: 'https://media.giphy.com/media/PNtvgNRPem010fdjnR/giphy.gif',
      palette: { bg: 'linear-gradient(160deg,#a8d8ea,#c3ecf7)', text: '#003d5b', accent: '#0077a8' }
    },
    {
      // legally blonde â€“ pastel pink
      url: 'https://media.giphy.com/media/xT8qAYyGomTMWkqyME/giphy.gif',
      palette: { bg: 'linear-gradient(160deg,#fbc7e4,#fde8f4)', text: '#7b0058', accent: '#d63fa3' }
    },
    {
      // house of joy â€“ warm olive/cream
      url: 'https://media.giphy.com/media/l46CjvmThdWAKD3nW/giphy.gif',
      palette: { bg: 'linear-gradient(160deg,#d4e09b,#f6f4d2)', text: '#3a4a00', accent: '#7cac00' }
    },
    {
      // direct giphy media
      url: 'https://media2.giphy.com/media/JQG2vMjZrbZ9hMrkZ5/giphy.gif',
      palette: { bg: 'linear-gradient(160deg,#b5ead7,#d0f4e8)', text: '#0a3d2a', accent: '#2dbb7c' }
    },
    {
      // relax game art â€“ deep purple/indigo
      url: 'https://media.giphy.com/media/HZZVCU446fkkxiqFFi/giphy.gif',
      palette: { bg: 'linear-gradient(160deg,#7b5ea7,#c9b8e8)', text: '#1c003d', accent: '#9b59b6' }
    },
    {
      // pixel lofi â€“ muted teal/navy
      url: 'https://media.giphy.com/media/xQ7NKUKR2qg0jQ5uwC/giphy.gif',
      palette: { bg: 'linear-gradient(160deg,#4a6fa5,#8ab4d9)', text: '#0c1f3f', accent: '#2980b9' }
    }
  ];

  const TIPS = [
    'ğŸ’¨ <strong>4-7-8 Breathing</strong><br/>Inhale 4s Â· Hold 7s Â· Exhale 8s',
    'ğŸ§˜ <strong>Neck Rolls</strong><br/>Slowly roll your neck left & right',
    'ğŸ‘ï¸ <strong>20-20-20 Rule</strong><br/>Look 20 ft away for 20 seconds',
    'ğŸ’§ <strong>Hydrate!</strong><br/>Go grab a glass of water now',
    'ğŸš¶ <strong>Micro Walk</strong><br/>Walk around for 2 minutes',
    'ğŸ¤² <strong>Hand Stretch</strong><br/>Open & close fists 10 times',
    'ğŸ§ <strong>Posture Reset</strong><br/>Shoulders back, chin tucked, spine tall',
    'ğŸ¦µ <strong>Calf Raises</strong><br/>Do 15 slow reps to wake up circulation',
    'ğŸªŸ <strong>Fresh Air Minute</strong><br/>Open a window or step outside briefly',
    'ğŸ« <strong>Box Breathing</strong><br/>Inhale 4s Â· Hold 4s Â· Exhale 4s Â· Hold 4s',
    'ğŸ§  <strong>Mind Sweep</strong><br/>Write one thought to clear mental clutter',
    'ğŸ‘€ <strong>Eye Palming</strong><br/>Cup warm palms over closed eyes for 20s',
    'ğŸ–ï¸ <strong>Wrist Mobility</strong><br/>Make slow circles both directions',
    'ğŸ <strong>Healthy Bite</strong><br/>Grab a fruit or nuts for steady energy',
    'ğŸ§ <strong>One Song Reset</strong><br/>Listen to one calming track, no screens',
    'ğŸ§¹ <strong>Tidy Sprint</strong><br/>Clear your desk for 60 focused seconds',
  ];

  // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Pick a random gif index stored in sessionStorage so it persists on reload
  // but each "open" (new tab) picks fresh random
  const gifIndex = Math.floor(Math.random() * GIFS.length);
  let activeGifIndex = gifIndex;
  let gifAttempts = 0;
  const DURATION = 5 * 60; // 5 minutes in seconds
  let remaining = DURATION;
  let timerInterval = null;

  // â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const gifImg       = document.getElementById('gif-img');
  const infoPanel    = document.getElementById('info-panel');
  const clockTrack   = document.getElementById('clock-track');
  const clockProg    = document.getElementById('clock-progress');
  const timeDisplay  = document.getElementById('time-display');
  const tipBox       = document.getElementById('tip-box');
  const doneMsg      = document.getElementById('done-msg');
  const CIRCUMF      = 2 * Math.PI * 68; // â‰ˆ 427.26

  // â”€â”€ Apply theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function applyTheme(idx) {
    const { bg, text, accent } = GIFS[idx].palette;
    infoPanel.style.background = bg;
    infoPanel.style.color      = text;
    clockTrack.style.stroke    = text;
    clockProg.style.stroke     = accent;
    const accentRgb = hexToRgb(accent);
    const textRgb = hexToRgb(text);
    if (accentRgb) infoPanel.style.setProperty('--theme-accent-rgb', accentRgb);
    if (textRgb) infoPanel.style.setProperty('--theme-text-rgb', textRgb);
  }

  function hexToRgb(hex) {
    const clean = hex.replace('#', '');
    if (!/^[0-9a-fA-F]{6}$/.test(clean)) return null;
    const n = parseInt(clean, 16);
    const r = (n >> 16) & 255;
    const g = (n >> 8) & 255;
    const b = n & 255;
    return `${r}, ${g}, ${b}`;
  }

  function setGif(idx) {
    activeGifIndex = idx;
    applyTheme(activeGifIndex);
    gifImg.src = GIFS[activeGifIndex].url;
  }

  // If a GIF fails to load, fall forward to the next one instead of blank panel.
  gifImg.onerror = () => {
    gifAttempts++;
    if (gifAttempts >= GIFS.length) return;
    const next = (activeGifIndex + 1) % GIFS.length;
    setGif(next);
  };

  gifImg.onload = () => {
    gifAttempts = 0;
  };

  // â”€â”€ Load GIF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  setGif(gifIndex);

  // Rotate tip randomly
  tipBox.innerHTML = TIPS[Math.floor(Math.random() * TIPS.length)];

  // â”€â”€ Countdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function formatTime(sec) {
    const m = String(Math.floor(sec / 60)).padStart(2, '0');
    const s = String(sec % 60).padStart(2, '0');
    return `${m}:${s}`;
  }

  function updateClock() {
    const frac = remaining / DURATION;
    clockProg.style.strokeDashoffset = CIRCUMF * (1 - frac);
    timeDisplay.textContent = formatTime(remaining);
  }

  function scheduleSystemBeeps() {
    fetch(`/api/sound/schedule-last-five?durationSeconds=${DURATION}`, { method: 'POST' })
      .catch(() => {
        // no-op if backend call fails
      });
  }

  function startTimer() {
    updateClock();
    timerInterval = setInterval(() => {
      remaining--;
      if (remaining < 0) {
        clearInterval(timerInterval);
        showDone();
        return;
      }
      updateClock();
    }, 1000);
  }

  function showDone() {
    document.getElementById('clock-wrap').style.display = 'none';
    tipBox.style.display = 'none';
    doneMsg.style.display = 'flex';

    // Auto-close tab 20 seconds after countdown finishes
    setTimeout(() => {
      window.close();
    }, 20000);
  }

  scheduleSystemBeeps();
  startTimer();
</script>
</body>
</html>
